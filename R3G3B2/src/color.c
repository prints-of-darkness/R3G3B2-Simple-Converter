/*********************************************************
 *                                                       *
 * MJM + AI 2025                                         *
 * This code is in the public domain.                    *
 * http://creativecommons.org/publicdomain/zero/1.0/     *
 *                                                       *
 *********************************************************/
#include <stdint.h>
#include <math.h>

#include "constrains.h"
#include "color.h"

static const RGBColor r3g3b2Palette[R3G3B2_COLOR_COUNT] = {
    { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x55 }, { 0x00, 0x00, 0xAA }, { 0x00, 0x00, 0xFF }, { 0x00, 0x24, 0x00 }, { 0x00, 0x24, 0x55 }, { 0x00, 0x24, 0xAA }, { 0x00, 0x24, 0xFF }, { 0x00, 0x48, 0x00 }, { 0x00, 0x48, 0x55 }, { 0x00, 0x48, 0xAA }, { 0x00, 0x48, 0xFF }, { 0x00, 0x6D, 0x00 }, { 0x00, 0x6D, 0x55 }, { 0x00, 0x6D, 0xAA }, { 0x00, 0x6D, 0xFF },
    { 0x00, 0x91, 0x00 }, { 0x00, 0x91, 0x55 }, { 0x00, 0x91, 0xAA }, { 0x00, 0x91, 0xFF }, { 0x00, 0xB6, 0x00 }, { 0x00, 0xB6, 0x55 }, { 0x00, 0xB6, 0xAA }, { 0x00, 0xB6, 0xFF }, { 0x00, 0xDA, 0x00 }, { 0x00, 0xDA, 0x55 }, { 0x00, 0xDA, 0xAA }, { 0x00, 0xDA, 0xFF }, { 0x00, 0xFF, 0x00 }, { 0x00, 0xFF, 0x55 }, { 0x00, 0xFF, 0xAA }, { 0x00, 0xFF, 0xFF },
    { 0x24, 0x00, 0x00 }, { 0x24, 0x00, 0x55 }, { 0x24, 0x00, 0xAA }, { 0x24, 0x00, 0xFF }, { 0x24, 0x24, 0x00 }, { 0x24, 0x24, 0x55 }, { 0x24, 0x24, 0xAA }, { 0x24, 0x24, 0xFF }, { 0x24, 0x48, 0x00 }, { 0x24, 0x48, 0x55 }, { 0x24, 0x48, 0xAA }, { 0x24, 0x48, 0xFF }, { 0x24, 0x6D, 0x00 }, { 0x24, 0x6D, 0x55 }, { 0x24, 0x6D, 0xAA }, { 0x24, 0x6D, 0xFF },
    { 0x24, 0x91, 0x00 }, { 0x24, 0x91, 0x55 }, { 0x24, 0x91, 0xAA }, { 0x24, 0x91, 0xFF }, { 0x24, 0xB6, 0x00 }, { 0x24, 0xB6, 0x55 }, { 0x24, 0xB6, 0xAA }, { 0x24, 0xB6, 0xFF }, { 0x24, 0xDA, 0x00 }, { 0x24, 0xDA, 0x55 }, { 0x24, 0xDA, 0xAA }, { 0x24, 0xDA, 0xFF }, { 0x24, 0xFF, 0x00 }, { 0x24, 0xFF, 0x55 }, { 0x24, 0xFF, 0xAA }, { 0x24, 0xFF, 0xFF },
    { 0x48, 0x00, 0x00 }, { 0x48, 0x00, 0x55 }, { 0x48, 0x00, 0xAA }, { 0x48, 0x00, 0xFF }, { 0x48, 0x24, 0x00 }, { 0x48, 0x24, 0x55 }, { 0x48, 0x24, 0xAA }, { 0x48, 0x24, 0xFF }, { 0x48, 0x48, 0x00 }, { 0x48, 0x48, 0x55 }, { 0x48, 0x48, 0xAA }, { 0x48, 0x48, 0xFF }, { 0x48, 0x6D, 0x00 }, { 0x48, 0x6D, 0x55 }, { 0x48, 0x6D, 0xAA }, { 0x48, 0x6D, 0xFF },
    { 0x48, 0x91, 0x00 }, { 0x48, 0x91, 0x55 }, { 0x48, 0x91, 0xAA }, { 0x48, 0x91, 0xFF }, { 0x48, 0xB6, 0x00 }, { 0x48, 0xB6, 0x55 }, { 0x48, 0xB6, 0xAA }, { 0x48, 0xB6, 0xFF }, { 0x48, 0xDA, 0x00 }, { 0x48, 0xDA, 0x55 }, { 0x48, 0xDA, 0xAA }, { 0x48, 0xDA, 0xFF }, { 0x48, 0xFF, 0x00 }, { 0x48, 0xFF, 0x55 }, { 0x48, 0xFF, 0xAA }, { 0x48, 0xFF, 0xFF },
    { 0x6D, 0x00, 0x00 }, { 0x6D, 0x00, 0x55 }, { 0x6D, 0x00, 0xAA }, { 0x6D, 0x00, 0xFF }, { 0x6D, 0x24, 0x00 }, { 0x6D, 0x24, 0x55 }, { 0x6D, 0x24, 0xAA }, { 0x6D, 0x24, 0xFF }, { 0x6D, 0x48, 0x00 }, { 0x6D, 0x48, 0x55 }, { 0x6D, 0x48, 0xAA }, { 0x6D, 0x48, 0xFF }, { 0x6D, 0x6D, 0x00 }, { 0x6D, 0x6D, 0x55 }, { 0x6D, 0x6D, 0xAA }, { 0x6D, 0x6D, 0xFF },
    { 0x6D, 0x91, 0x00 }, { 0x6D, 0x91, 0x55 }, { 0x6D, 0x91, 0xAA }, { 0x6D, 0x91, 0xFF }, { 0x6D, 0xB6, 0x00 }, { 0x6D, 0xB6, 0x55 }, { 0x6D, 0xB6, 0xAA }, { 0x6D, 0xB6, 0xFF }, { 0x6D, 0xDA, 0x00 }, { 0x6D, 0xDA, 0x55 }, { 0x6D, 0xDA, 0xAA }, { 0x6D, 0xDA, 0xFF }, { 0x6D, 0xFF, 0x00 }, { 0x6D, 0xFF, 0x55 }, { 0x6D, 0xFF, 0xAA }, { 0x6D, 0xFF, 0xFF },
    { 0x91, 0x00, 0x00 }, { 0x91, 0x00, 0x55 }, { 0x91, 0x00, 0xAA }, { 0x91, 0x00, 0xFF }, { 0x91, 0x24, 0x00 }, { 0x91, 0x24, 0x55 }, { 0x91, 0x24, 0xAA }, { 0x91, 0x24, 0xFF }, { 0x91, 0x48, 0x00 }, { 0x91, 0x48, 0x55 }, { 0x91, 0x48, 0xAA }, { 0x91, 0x48, 0xFF }, { 0x91, 0x6D, 0x00 }, { 0x91, 0x6D, 0x55 }, { 0x91, 0x6D, 0xAA }, { 0x91, 0x6D, 0xFF },
    { 0x91, 0x91, 0x00 }, { 0x91, 0x91, 0x55 }, { 0x91, 0x91, 0xAA }, { 0x91, 0x91, 0xFF }, { 0x91, 0xB6, 0x00 }, { 0x91, 0xB6, 0x55 }, { 0x91, 0xB6, 0xAA }, { 0x91, 0xB6, 0xFF }, { 0x91, 0xDA, 0x00 }, { 0x91, 0xDA, 0x55 }, { 0x91, 0xDA, 0xAA }, { 0x91, 0xDA, 0xFF }, { 0x91, 0xFF, 0x00 }, { 0x91, 0xFF, 0x55 }, { 0x91, 0xFF, 0xAA }, { 0x91, 0xFF, 0xFF },
    { 0xB6, 0x00, 0x00 }, { 0xB6, 0x00, 0x55 }, { 0xB6, 0x00, 0xAA }, { 0xB6, 0x00, 0xFF }, { 0xB6, 0x24, 0x00 }, { 0xB6, 0x24, 0x55 }, { 0xB6, 0x24, 0xAA }, { 0xB6, 0x24, 0xFF }, { 0xB6, 0x48, 0x00 }, { 0xB6, 0x48, 0x55 }, { 0xB6, 0x48, 0xAA }, { 0xB6, 0x48, 0xFF }, { 0xB6, 0x6D, 0x00 }, { 0xB6, 0x6D, 0x55 }, { 0xB6, 0x6D, 0xAA }, { 0xB6, 0x6D, 0xFF },
    { 0xB6, 0x91, 0x00 }, { 0xB6, 0x91, 0x55 }, { 0xB6, 0x91, 0xAA }, { 0xB6, 0x91, 0xFF }, { 0xB6, 0xB6, 0x00 }, { 0xB6, 0xB6, 0x55 }, { 0xB6, 0xB6, 0xAA }, { 0xB6, 0xB6, 0xFF }, { 0xB6, 0xDA, 0x00 }, { 0xB6, 0xDA, 0x55 }, { 0xB6, 0xDA, 0xAA }, { 0xB6, 0xDA, 0xFF }, { 0xB6, 0xFF, 0x00 }, { 0xB6, 0xFF, 0x55 }, { 0xB6, 0xFF, 0xAA }, { 0xB6, 0xFF, 0xFF },
    { 0xDA, 0x00, 0x00 }, { 0xDA, 0x00, 0x55 }, { 0xDA, 0x00, 0xAA }, { 0xDA, 0x00, 0xFF }, { 0xDA, 0x24, 0x00 }, { 0xDA, 0x24, 0x55 }, { 0xDA, 0x24, 0xAA }, { 0xDA, 0x24, 0xFF }, { 0xDA, 0x48, 0x00 }, { 0xDA, 0x48, 0x55 }, { 0xDA, 0x48, 0xAA }, { 0xDA, 0x48, 0xFF }, { 0xDA, 0x6D, 0x00 }, { 0xDA, 0x6D, 0x55 }, { 0xDA, 0x6D, 0xAA }, { 0xDA, 0x6D, 0xFF },
    { 0xDA, 0x91, 0x00 }, { 0xDA, 0x91, 0x55 }, { 0xDA, 0x91, 0xAA }, { 0xDA, 0x91, 0xFF }, { 0xDA, 0xB6, 0x00 }, { 0xDA, 0xB6, 0x55 }, { 0xDA, 0xB6, 0xAA }, { 0xDA, 0xB6, 0xFF }, { 0xDA, 0xDA, 0x00 }, { 0xDA, 0xDA, 0x55 }, { 0xDA, 0xDA, 0xAA }, { 0xDA, 0xDA, 0xFF }, { 0xDA, 0xFF, 0x00 }, { 0xDA, 0xFF, 0x55 }, { 0xDA, 0xFF, 0xAA }, { 0xDA, 0xFF, 0xFF },
    { 0xFF, 0x00, 0x00 }, { 0xFF, 0x00, 0x55 }, { 0xFF, 0x00, 0xAA }, { 0xFF, 0x00, 0xFF }, { 0xFF, 0x24, 0x00 }, { 0xFF, 0x24, 0x55 }, { 0xFF, 0x24, 0xAA }, { 0xFF, 0x24, 0xFF }, { 0xFF, 0x48, 0x00 }, { 0xFF, 0x48, 0x55 }, { 0xFF, 0x48, 0xAA }, { 0xFF, 0x48, 0xFF }, { 0xFF, 0x6D, 0x00 }, { 0xFF, 0x6D, 0x55 }, { 0xFF, 0x6D, 0xAA }, { 0xFF, 0x6D, 0xFF },
    { 0xFF, 0x91, 0x00 }, { 0xFF, 0x91, 0x55 }, { 0xFF, 0x91, 0xAA }, { 0xFF, 0x91, 0xFF }, { 0xFF, 0xB6, 0x00 }, { 0xFF, 0xB6, 0x55 }, { 0xFF, 0xB6, 0xAA }, { 0xFF, 0xB6, 0xFF }, { 0xFF, 0xDA, 0x00 }, { 0xFF, 0xDA, 0x55 }, { 0xFF, 0xDA, 0xAA }, { 0xFF, 0xDA, 0xFF }, { 0xFF, 0xFF, 0x00 }, { 0xFF, 0xFF, 0x55 }, { 0xFF, 0xFF, 0xAA }, { 0xFF, 0xFF, 0xFF }
};

// Weights for the red, green, and blue channels
static const float wr = 0.299f;
static const float wg = 0.587f;
static const float wb = 0.114f;

static float calculateWeightedDistance(uint8_t r1, uint8_t g1, uint8_t b1, uint8_t r2, uint8_t g2, uint8_t b2)
{
    float dr = (float)r1 - r2;
    float dg = (float)g1 - g2;
    float db = (float)b1 - b2;
    return sqrtf(wr * dr * dr + wg * dg * dg + wb * db * db);
}

// using weighted euclidean distance
void quantize_pixel_with_map_reduced(uint8_t* r, uint8_t* g, uint8_t* b)
{
    float minDistance = INFINITY;
    int   closestIndex = 0;

    for (int i = 0; i < R3G3B2_COLOR_COUNT; i++) {
        float distance = calculateWeightedDistance(*r, *g, *b, r3g3b2Palette[i].r, r3g3b2Palette[i].g, r3g3b2Palette[i].b);
        if (distance < minDistance) {
            minDistance = distance;
            closestIndex = i;
        }
    }

    *r = r3g3b2Palette[closestIndex].r;
    *g = r3g3b2Palette[closestIndex].g;
    *b = r3g3b2Palette[closestIndex].b;
}

uint8_t rgbToRgb332(uint8_t r, uint8_t g, uint8_t b)
{
    return ((r & 0xE0) | ((g & 0xE0) >> 3) | (b >> 6));
}